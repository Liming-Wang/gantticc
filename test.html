<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>Gantticc Test Drive</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1">
	<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1.0">
	<script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/bootstrap-datepicker.js"></script>
	<script src="https://cdn.firebase.com/v0/firebase.js"></script>
	<script type="text/javascript" src="js/gantticc.js"></script>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/datepicker.css">
</head>

<style>
body .container-fluid{
margin:0;
padding:0;
}
#topbar{
overflow:visible;
*position:relative;
*z-index:2;
}
#project_title{
display:inline-block;
font-size:20px;
font-weight:200;
line-height:30px;
color:#777777;
text-shadow:0 1px 0 #ffffff;
}
.topbar-inner{
min-height:40px;
background-color:#fafafa;
background-image:-moz-linear-gradient(top, #ffffff, #f2f2f2);
background-image:-webkit-gradient(linear, 0 0, 0 100%, from(#ffffff), to(#f2f2f2));
background-image:-webkit-linear-gradient(top, #ffffff, #f2f2f2);
background-image:-o-linear-gradient(top, #ffffff, #f2f2f2);
background-image:linear-gradient(to bottom, #ffffff, #f2f2f2);
background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffffff', endColorstr='#fff2f2f2', GradientType=0);
border-top:1px solid #d4d4d4;
border-bottom:1px solid #d4d4d4;
-webkit-box-shadow:0 1px 4px rgba(0, 0, 0, 0.065);
-moz-box-shadow:0 1px 4px rgba(0, 0, 0, 0.065);
box-shadow:0 1px 4px rgba(0, 0, 0, 0.065);
*zoom:1;
}
.topbar-inner:before,.topbar-inner:after{display:table;content:"";line-height:0;}
.topbar-inner:after{clear:both;}
.topbar-inner > div{
margin-top:5px;
}
.topbar-inner .dropdown-menu{
min-width:80px;
}
#settings{
display:none;
}
#gantt{
z-index:1;
overflow-y:hidden;
overflow-x:hidden;
min-height:360px;
}
#task_form{
display:none;
position:absolute;
background:#eee;
padding:5px 10px 10px 10px;
z-index:10;
border:2px solid #bbb;
border-radius:4px;
-webkit-box-shadow:0 0 5px #aaa;
box-shadow:0 0 5px #aaa;
}
#task_form .close{
display:inline-block;
float:right;
cursor:pointer;
line-height:14px;
padding:0 0 8px 0;
}
.topbar-inner .swatch_block{
margin-top:4px;
width:16px;
}
.topbar-inner .swatch_check,
.topbar-inner .swatch_checked{
color:#fff;
display:inline-block;
width:12px;
line-height:16px;
vertical-align:top;
padding:6px 0 0 12px;
}
.topbar-inner .swatch_checked{
color:#000;
}
.swatch_block{
display:inline-block;
width:22px;
height:16px;
margin-left:2px;
cursor:pointer;
border:1px solid #ccc;
}
.swatch_sel{
border:1px solid #333;
}
.swatch_null{
background:#fff;
}
.swatch_gray{
background:#e5e5e5;
}
.swatch_blue{
background:#bee1ef;
}
.swatch_orange{
background:#ff944d;
}
#mselects{
position:absolute;
z-index:1000;
display:none;
text-align:left;
min-width:160px;
padding:5px 0;
margin:30px 0 0 0;
list-style:none;
background-color:#ffffff;
border:1px solid #ccc;
border:1px solid rgba(0, 0, 0, 0.2);
*border-right-width:2px;
*border-bottom-width:2px;
-webkit-border-radius:6px;
-moz-border-radius:6px;
border-radius:6px;
-webkit-box-shadow:0 5px 10px rgba(0, 0, 0, 0.2);
-moz-box-shadow:0 5px 10px rgba(0, 0, 0, 0.2);
box-shadow:0 5px 10px rgba(0, 0, 0, 0.2);
-webkit-background-clip:padding-box;
-moz-background-clip:padding;
background-clip:padding-box;
}
#mselects li > a{
display:block;
padding:3px 20px;
clear:both;
font-weight:normal;
line-height:20px;
color:#333333;
white-space:nowrap;
}
#mselects li > a:hover,
#mselects li > a:focus{
text-decoration:none;
color:#ffffff;
background-color:#0081c2;
background-image:-moz-linear-gradient(top, #0088cc, #0077b3);
background-image:-webkit-gradient(linear, 0 0, 0 100%, from(#0088cc), to(#0077b3));
background-image:-webkit-linear-gradient(top, #0088cc, #0077b3);
background-image:-o-linear-gradient(top, #0088cc, #0077b3);
background-image:linear-gradient(to bottom, #0088cc, #0077b3);
background-repeat:repeat-x;
filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ff0088cc', endColorstr='#ff0077b3', GradientType=0);
}
#mselects .disabled > a,
#mselects .disabled > a:hover{
color:#999999;
}
#mselects .disabled > a:hover{
text-decoration:none;
background-color:transparent;
background-image:none;
filter:progid:DXImageTransform.Microsoft.gradient(enabled = false);
cursor:default;
}
svg {
font-size:10px;
shape-rendering:crispEdges;
}
.day {
fill:#fff;
stroke:#000;
stroke-opacity:.1;
}
.month {
fill:none;
stroke:#000;
stroke-width:2px;
}
</style>

<body>
<div class="container-fluid">
<div id="settings" class="container-fluid">
	<div class="row-fluid"><div class="span12 form-inline" style="padding:10px;">
		<label for="project_title">Project: </label>
		<div class="input-prepend">
			<div class="btn-group">
				<button class="btn dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
				<ul id="project_list" class="dropdown-menu"></ul>
			</div>
			<input type="text" id="project_title_txtfield" name="project_title" value="" />
		</div>
		<label for="project_startdate">Start: </label>
		<input type="text" class="input-small datepickr" name="project_startdate" id="project_startdate" value="" size="12" />
		<label for="project_enddate">End: </label>
		<input type="text" class="input-small datepickr" name="project_enddate" id="project_enddate" value="" size="12" />
		<button class="btn" onclick="project_update();">
			<span class="icon-ok"></span>
		</button>
		<a class="btn" href="#project_delete_modal" role="button" data-toggle="modal" rel="tooltip" data-placement="bottom" data-original-title="Delete Project">
			<span class="icon-trash"></span>
		</a>
		<a class="btn" href="#project_info_modal" role="button" data-toggle="modal" rel="tooltip" data-placement="bottom" data-original-title="Project Info">
			<span class="icon-info-sign"></span>
		</a>
		<a class="btn" href="#project_share_modal" role="button" data-toggle="modal" rel="tooltip" data-placement="bottom" data-original-title="Share">
			<span class="icon-share-alt"></span>
		</a>
	</div></div>
</div>
<div id="topbar" class="row-fluid"><div class="topbar-inner">
	<div class="span4">
		<div style="padding-left:10px;">
		<a class="btn" onclick="toggle_settings();" href="#">
			<span id="settings_toggler" class="icon-arrow-down"></span>
		</a></div>
	</div>
	<div class="span4" id="topbar-center" style="text-align:center;"><div>
		<button class="btn" onclick="gchart_jump('left');">
			<span class="icon-arrow-left"></span>
		</button>
		<button id="mtab" class="btn" href="#" value="" data-placement="bottom" data-original-title="Jump to"></button>
		<button class="btn" onclick="gchart_jump('right');">
			<span class="icon-arrow-right"></span>
		</button>
		<ul id="mselects"></ul>
	</div></div>
	<div class="span4 hideme" style="text-align:right;">
		<div style="padding-right:10px;">
		<div class="btn-group" style="text-align:left;">
			<a href="#" id="task_color_sel_menu" role="button" class="btn dropdown-toggle" data-toggle="dropdown">
				<span class="icon-adjust"></span>
				<b class="caret"></b>
			</a>
			<ul class="dropdown-menu" style="min-width:66px;" role="menu" aria-labelledby="task_color_sel_menu">
				<li><a tabindex="-1" onclick="toggle_swatch_color('gray');" href="#">
					<span class="swatch_block swatch_gray"></span><span class="swatch_check swatch_checked">&#10003;</span>
				</a></li>
				<li><a tabindex="-1" onclick="toggle_swatch_color('blue');" href="#">
					<span class="swatch_block swatch_blue"></span><span class="swatch_check swatch_checked">&#10003;</span>
				</a></li>
				<li><a tabindex="-1" onclick="toggle_swatch_color('orange');" href="#">
					<span class="swatch_block swatch_orange"></span><span class="swatch_check swatch_checked">&#10003;</span>
				</a></li>
			</ul>
		</div>
		<div class="btn-group" style="text-align:left;">
			<a href="#" id="view_mode" role="button" class="btn dropdown-toggle" data-toggle="dropdown">
				<span class="icon-eye-open"></span>
				<b class="caret"></b>
			</a>
			<ul class="dropdown-menu" role="menu" aria-labelledby="view_mode">
				<li><a tabindex="-1" href="#" onclick="set_scale('day');">Day</a></li>
				<li><a tabindex="-1" href="#" onclick="set_scale('week');">Week</a></li>
				<li class="divider"></li>
				<li><a id="heatmap_status" tabindex="-1" href="#" onclick="project_heatmap();">Heat Map</a></li>
			</ul>
		</div>
		<div class="btn-group" style="text-align:left;">
			<a class="btn" href="#gantticc_help_modal" role="button" data-toggle="modal">
				<span class="icon-question-sign"></span>
			</a>
		</div>
		</div>
	</div>
</div></div>
<div class="row-fluid"><div id="gantt"></div></div>
<div id="task_form">
	<div style="width:100%;padding:0 5px 3px 0;">
		<span class="close" onclick="task_form_cancel();">&times;</span>
	</div>
	<input type="hidden" id="title_tid" value="" />
	<input type="text" id="title_txtfield" value="" /><br/>
	<input type="hidden" id="task_color" value="" />
	<div style="width:100%;margin:0 0 5px 0;">
		<span id="task_color_gray" onclick="task_form_set_color('gray')" class="swatch_block swatch_gray"></span>
		<span id="task_color_blue" onclick="task_form_set_color('blue')" class="swatch_block swatch_blue"></span>
		<span id="task_color_orange" onclick="task_form_set_color('orange')" class="swatch_block swatch_orange"></span>
	</div>
	<textarea rows="4" cols="18" id="notes_txtfield"></textarea><br/>
	<button class="btn" onclick="task_form_submit();">Save</button>
	<button class="btn" style="float:right;" onclick="task_form_delete();"><span class="icon-trash"></span></button>
</div>
<div id="project_delete_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3>Delete Project</h3>
	</div>
	<div class="modal-body"><p>Are you sure you want to delete this project?</p></div>
	<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">No</a>
		<button class="btn btn-danger" data-dismiss="modal" aria-hidden="true" onclick="delete_cur_project();">Delete project</a>
	</div>
</div>
<div id="project_info_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3>Project Info</h3>
	</div>
	<div id="project_info" class="modal-body"></div>
	<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">Close</a>
	</div>
</div>
<div id="gantticc_help_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3>Help</h3>
	</div>
	<div class="modal-body">
		<p>If you find any issues, you can submit them to this project's <a href="https://github.com/xlphs/gantticc">github page</a>.</p>
		<h4>Tasks</h4>
		<ul>
			<li>To create, double click on empty space.</li>
			<li>To set start date, click and drag task bubble to desired position.</li>
			<li>To set end date, click on the right edge and drag to desired position.</li>
			<li>To view/edit details, click on task bubble.</li>
		</ul>
		<h4>Navigation</h4>
		<ul>
			<li>Click and drag the background to scroll.</li>
		</ul>
		<h4>Hot Keys</h4>
		<ul>
			<li><code>h</code>: switch to/from heat map mode.</li>
			<li><code>d</code>: set unit to day, and/or jump to today.</li>
			<li><code>w</code>: set unit to week, and/or jump to current week.</li>
		</ul>
	</div>
	<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">Close</a>
	</div>
</div>
<div id="project_share_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3>Project Info</h3>
	</div>
	<div class="modal-body">
		<div class="form-horizontal">
			<div class="control-group" id="prj_sharefrm_group">
			<label class="control-label" for="project_share_id">Sharing id: </label>
			<div class="controls">
				<input type="text" class="input" name="project_share_id" id="project_share_id" value="" size="12" />
				<span class="help-inline"></span>
			</div>
			</div>
			<div class="control-group">
				<span class="help-block" id="prj_sharefrm_output">Your sharing url will be: </span>
				<div class="controls"><button class="btn btn-primary" onlick="project_share();">Submit</a></div>
			</div>
		</div>
	</div>
	<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</a>
	</div>
</div>
</div>
</body>

<script type="text/javascript" src="js/bonsai.min.js"></script>
<script type="text/javascript">
	var gchart;
	
	$(function(){
		// ---- Entry point ----
		// setup date picker
		$(".datepickr").datepicker();
		$(".datepickr").on('click', function(e){
			$(e.target).datepicker('show');
		});
		$(".datepickr").on('changeDate', function(e){
			$(e.target).datepicker('hide');
		});
		// setup tooltips
		$('a[rel=tooltip]').tooltip();
		// setup jump-to-month dropdown
		$('#mtab').on('click', function(){
			var x = $('#mtab').offset().left;
			var y = $('#mtab').offset().top;
			$('#mselects').css({ left: x, top: y+2 });
			$('#mselects').show();
		});
		$(document).bind('mouseup touchstart', function(e){
		    var msel = $('#mselects');
			if (!msel.is(e.target) && msel.has(e.target).length === 0){
				msel.hide();
			}
		});
		$(document).on('keydown', function(e){
			if (e.keyCode == 27) {
				// listen for escape
				if ($('#task_form').is(':visible')) task_form_cancel();
				if ($('#mselects').is(':visible')) $('#mselects').hide();
			} else if (e.keyCode == 72) {
				// listen for heatmap hotkey "h"
				if (gantticc.listenKey && !$('#task_form').is(':visible')) project_heatmap();
			} else if (e.keyCode == 68) {
				// switch to day mode "d"
				if (gantticc.listenKey && !$('#task_form').is(':visible')) set_scale("day");
			} else if (e.keyCode == 87) {
				// switch to week mode "d"
				if (gantticc.listenKey && !$('#task_form').is(':visible')) set_scale("week");
			}
		});
		// handle keydown event or not
		$('input[type=text]')
		    .bind("focus", function(){ gantticc.listenKey = false; })
		    .bind("blur", function(){ gantticc.listenKey = true; });
		$('textarea')
		    .bind("focus", function(){ gantticc.listenKey = false; })
		    .bind("blur", function(){ gantticc.listenKey = true; });
		// setup project info model
		$('#project_info_modal').on('show', function(){
			var html = [];
			html.push("<p>Number of tasks: "+gantticc.project.tasks.length+"</p>");
			html.push("<p>CSV data can be imported into other apps such as Google Calendar. Just copy and paste the text below and save as a .csv file.</p>");
			html.push("<textarea class=\"span6\" rows=\"5\">"+gantticc.exportData("google_cal")+"</textarea>");
			$('#project_info').html(html.join(""));
		});
		if ( $('#topbar').height() > 44) {
			// hide not-so-useful icons for small screen size
			$('.hideme').each(function(){
				$(this).hide();
			});
			$('#topbar-center').removeClass('span4').addClass('span8');
		}
		// init
		gantticc.init();
		
		gchart = bonsai.run(document.getElementById('gantt'),{
			url: 'js/gchart.js?bustcache='+Math.random(),
			width: gantticc.getWidth(),
			height: gantticc.getHeight(),
			code: function(){
				stage.on('message:update_task', function(data){
					if (data.cancel === 'true'){
						ganttClickLock = 0;
						return;
					}
					var task = null;
					// find task by task id
					var i = 0;
					for (i; i < gantticc.tasks.length; i++){
						task = gantticc.tasks[i];
						if (task.tid == data.tid) break;
					}
					if (task == null) return;
					if (data.delete === 'true'){
						gchart.deleteTaskAnim(task.group_asset);
						gantticc.tasks.splice(i, 1);
					} else{
						data.title = data.title;
						task.title_asset.attr('text', data.title);
						task.updateIndicatorIcon(data.notes);
						task.updateTaskColor(data.color);
					}
					ganttClickLock = 0;
				});
				stage.on('message:update_project', function(data){
					if ((typeof data.start_date) != 'undefined'){
						var scroll_date = new Date();
						if (data.scroll_date) {
							scroll_date = new Date(data.scroll_date);
						}
						gchart.drawHeader(data.start_date, data.end_date);
						gchart.scrollToDate(scroll_date);
						gchart.updateCurrentUnit();
					}
				});
				stage.on('message:init_tasks', function(data){
					var scroll_date = new Date();
					if (data.no_scroll) {
						scroll_date = gchart.getScrollDate();
					}
					gchart.initTasks(data.tasks);
					gchart.scrollToDate(scroll_date);
					// update jump to month button
					stage.sendMessage('scroll_date', {date: scroll_date});
				});
				stage.on('message:init_heatmap', function(data){
					// preserve current scroll position
					var scrollDate = gchart.getScrollDate();
					// check unit
					if (gchart.unit !== data.unit) {
						gchart.unit = data.unit;
					}
					gchart.drawHeader(data.start_date, data.end_date);
					gchart.updateCurrentUnit(1);
					gchart.initHeatMap({
						min: data.min,
						max: data.max,
						projects: data.data
					});
					gchart.scrollToDate(scrollDate);
					// update jump to month button
					stage.sendMessage('scroll_date', {date: scrollDate});
				});
				stage.on('message:scroll_to_date', function(data){
					var date = new Date(data.date);
					gchart.scrollToDate(date);
				});
				stage.on('message:set_swatch', function(data){
					gchart.highlightTaskByColor(data.color, data.status);
				});
				stage.on('message:set_scale', function(data){
					var scrollDate = new Date();
					if (gchart.unit === data.unit){
						// jump to today if no change
						gchart.scrollToDate(scrollDate);
					} else {
						// preserve current scroll position
						scrollDate = gchart.getScrollDate();
						gchart.unit = data.unit;
						gchart.drawHeader(data.start_date, data.end_date);
						gchart.updateCurrentUnit(1);
						gchart.scrollToDate(scrollDate);
					}
					// update jump to month button
					stage.sendMessage('scroll_date', {date: scrollDate});
				});
				stage.sendMessage('ready',{});
			}
		});
	
		gchart.on('load', function(data){
			gchart.on('message:ready', function(data){
				var startdate = new Date($('#project_startdate').val()).toISOString();
				var enddate = new Date($('#project_enddate').val()).toISOString();
				gchart.sendMessage('update_project',{
					start_date: startdate,
					end_date: enddate
				});
				gchart.sendMessage('init_tasks',{
					tasks: gantticc.project.tasks
				});
			});
			gchart.on('message:edit_task', function(data){
				var task = gantticc.project.getTask(data.tid);
				if (task == null) return;
				// show the title edit form
				$('#title_tid').val(task.tid);
				$('#title_txtfield').val(task.title);
				if (!task.color) task.color = "gray";
				$('#task_color').val(task.color);
				for (var i=0; i<gantticc.colors.length; i++){
					var c = gantticc.colors[i];
					$('#task_color_'+c).removeClass('swatch_sel');
				}
				$('#task_color_'+task.color).addClass('swatch_sel');
				$('#notes_txtfield').val(task.notes);
				var y_pos = data.y+$('#topbar').height();
				if ( !$('#settings').is(":hidden") ) y_pos += $('#settings').height();
				$('#task_form').css({ top: y_pos, left: data.x });
				$('#task_form').show();
			});
			gchart.on('message:update_task', function(data){
				var task = gantticc.project.getTask(data.tid);
				if (task == null) return;
				if (data.start) task.start = data.start;
				if (data.end) task.end = data.end;
				if (data.row) task.row = data.row;
				gantticc.project.saveTasks();
			});
			gchart.on('message:new_task', function(data){
				gantticc.project.addTask(data.task);
			});
			gchart.on('message:scroll_date', function(data){
				var cur = new Date(data.date);
				gantticc.updateCurrentMonthBtn(cur);
			});
		});
		// apply data into ui
		gantticc.applyCurrentProject();
		gantticc.updateProjectList();
	});
	
	function task_form_delete(){
		gchart.sendMessage('update_task',{
			tid: $('#title_tid').val(),
			delete: 'true'
		});
		$('#task_form').hide();
		gantticc.project.deleteTask($('#title_tid').val());
	}
	
	function task_form_cancel(){
		gchart.sendMessage('update_task',{
			tid: $('#title_tid').val(),
			cancel: 'true'
		});
		$('#task_form').hide();
		$("#title_txtfield").trigger("blur");
		$("#notes_txtfield").trigger("blur");
	}
	
	function task_form_submit(){
		var task = gantticc.project.getTask($('#title_tid').val());
		if (task == null) return;
		task.title = $('#title_txtfield').val();
		task.color = $('#task_color').val();
		task.notes = $('#notes_txtfield').val();
		gchart.sendMessage('update_task',{
			tid: task.tid,
			title: task.title,
			color: task.color,
			notes: task.notes
		});
		$('#task_form').hide();
		gantticc.project.saveTasks();
	}
	
	function task_form_set_color(color){
		for (var i=0; i<gantticc.colors.length; i++){
			var c = gantticc.colors[i];
			$('#task_color_'+c).removeClass('swatch_sel');
		}
		$('#task_color_'+color).addClass('swatch_sel');
		$('#task_color').val(color);
	}
	
	function project_update(){
		var startdate = new Date($('#project_startdate').val()).toISOString();
		var enddate = new Date($('#project_enddate').val()).toISOString();
		gchart.sendMessage('update_project',{
			start_date: startdate,
			end_date: enddate
		});
		gantticc.project.title = $('#project_title_txtfield').val();
		gantticc.project.start = startdate;
		gantticc.project.end = enddate;
		gantticc.project.save();
		gantticc.project.saveTasks();
		// make sure mtab is within scale
		var current = new Date($('#mtab').attr('value'));
		var to = current;
		if (current < new Date(gantticc.project.start)){
			to = new Date(gantticc.project.start);
			gchart_scroll(to);
		} else if (current > new Date(gantticc.project.end)){
			to = new Date(gantticc.project.end);
			gchart_scroll(to);
		}
		gantticc.updateJumpMonthMenu();
		gantticc.updateProjectList();
	}
	
	function delete_cur_project(){
		gantticc.deleteCurrentProject();
		gantticc.applyCurrentProject();
		gchart.sendMessage('init_tasks',{
			tasks: gantticc.project.tasks
		});
	}
	
	function project_new(){
		if (gantticc.addNewProject() == null) {
			alert("Cannot create more than "+gantticc.maxProjCount+" projects.");
			return;
		}
		gantticc.applyCurrentProject();
		gchart.sendMessage('init_tasks',{
			tasks: gantticc.project.tasks
		});
	}
	
	function project_load(pid){
		gantticc.setCurrentProject(pid);
		gchart.sendMessage('init_tasks',{
			tasks: gantticc.project.tasks
		});
		gantticc.resetHeatmap();
		gantticc.resetSwatch();
	}
	
	function gchart_jump(dir){
		var current = new Date($('#mtab').attr('value'));
		var y = current.getFullYear();
		var m = current.getMonth();
		var d = 1;
		if (dir === "left"){
			m--;
			if (m < 0){
				y--;
				m = 11;
			}
		} else if (dir === "right"){
			m++;
			if (m == 12){
				y++;
				m = 0;
			}
		}
		var to = new Date(y,m,1);
		var start = new Date(gantticc.project.start);
		var end = new Date(gantticc.project.end);
		if (gantticc.heatmap.start) {
			var a = new Date(gantticc.heatmap.start);
			var b = new Date(gantticc.heatmap.end);
			if (start > a) start = a;
			if (end < b) end = b;
		}
		if (to > end) return;
		if (to < start){
			// jump to first day of project
			to = start;
		}
		gchart_scroll(to);
		gantticc.updateCurrentMonthBtn(to);
	}
	
	function gchart_scroll(date){
		gchart.sendMessage('scroll_to_date',{
			date: date.toISOString()
		});
		gantticc.updateCurrentMonthBtn(date);
		$('#mselects').hide();
	}
	
	function set_scale(unit){
		var start = gantticc.project.start;
		var end = gantticc.project.end;
		if (gantticc.heatmap.start) {
			project_heatmap(unit, 1);
			return;
		}
		gchart.sendMessage('set_scale',{
			unit: unit,
			start_date: start,
			end_date: end
		});
	}
	
	function toggle_swatch_color(color){
		if (gantticc.heatmap.start) return;
		var el = $('.swatch_'+color).next().first();
		el.toggleClass('swatch_checked');
		var enable = false;
		if (el.hasClass('swatch_checked')) {
			enable = true;
		}
		gchart.sendMessage('set_swatch',{
			color: color, status: enable
		});
	}
	
	function toggle_settings(){
		if ( $('#settings').is(":hidden") ){
			$('#settings_toggler').removeClass("icon-arrow-down").addClass("icon-arrow-up");
			$('#settings').slideDown();
		} else{
			$('#settings_toggler').addClass("icon-arrow-down").removeClass("icon-arrow-up");
			$('#settings').slideUp();
		}
	}
	
	function project_heatmap(unit, update){
		// Handle UI events
		if (!update) {
			if ($('#heatmap_status').attr('value') === "on") {
				gantticc.resetHeatmap();
				var scrollTo = new Date($('#mtab').attr('value'));
				if (scrollTo < new Date(gantticc.project.start)) {
					scrollTo = new Date(gantticc.project.start);
				}
				gchart.sendMessage('update_project',{
					start_date: gantticc.project.start,
					end_date: gantticc.project.end,
					scroll_date: scrollTo
				});
				gchart.sendMessage('init_tasks',{
					tasks: gantticc.project.tasks,
					no_scroll: true
				});
				gantticc.resetSwatch();
				gantticc.updateJumpMonthMenu();
				gantticc.updateCurrentMonthBtn(scrollTo);
				gantticc.heatmap = {};
				return;
			} else {
				$('#heatmap_status').html('<b>Heat Map</b>');
				$('#heatmap_status').attr('value', 'on');
			}
		}
		if (!unit) unit = "day";
		// 1. Get the start/end date by looking at all projects
		var start = new Date(gantticc.project.start).getTime();
		var end = new Date(gantticc.project.end).getTime();
		for (var i=0; i<gantticc.projects.length; i++){
			var prj = gantticc.projects[i];
			var a = new Date(prj.start).getTime();
			var b = new Date(prj.end).getTime();
			if (start > a) start = a;
			if (end < b) end = b;
		}
		// 2. For each day/week, compute the number of tasks
		var theData = [],
			totalData = [],
			max = 0,
			incTime = 1000*3600*24;
		if (unit === "week") incTime = incTime * 7; // 7 days a week
		for (var t=start; t<=end; t+=incTime) {
			var tasks;
			var date = new Date(t);
			if (unit === "day") {
				tasks = gantticc.getAllTasksOnDate(date);
			} else {
				tasks = gantticc.getAllTasksInWeek(date.getWeekNumber(date));
			}
			var data = { date: t, tasks: tasks };
			if (max < tasks.length) max = tasks.length;
			totalData.push(data);
		}
		max++; // for max opacity 0.9 so that grid lines remain visible
		// 3. For each project, generate data for plotting
		var projectsData = [];
		for (var i=0; i<gantticc.projects.length; i++){
			var prj = gantticc.projects[i];
			var data = {
				title: prj.title,
				data: prj.getDataForHeatMap(unit)
			}
			projectsData.push(data);
		}
		theData = [{ title: "Total", data: totalData }];
		$.merge(theData, projectsData);
		
		gchart.sendMessage('init_heatmap',{
			start_date: new Date(start).toISOString(),
			end_date: new Date(end).toISOString(),
			unit: unit,
			data: theData,
			min: 0, max: max
		});
		gantticc.heatmap = {
			start: new Date(start).toISOString(),
			end: new Date(end).toISOString()
		}
		gantticc.updateJumpMonthMenu(gantticc.heatmap.start, gantticc.heatmap.end);
	}
	
	function project_share() {
		var shareId = $('project_share_id').val();
		if ( gantticc.verifySharingId(shareId) ) {
			$('project_share_id').parent().parent().removeClass('error').addClass("success");
			gantticc.setFirebaseId(shareId);
			gantticc.shareToFirebase();
		} else {
			$('project_share_id').parent().parent().addClass('error');
		}
	}
	
</script>

</html>